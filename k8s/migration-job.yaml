apiVersion: batch/v1
kind: Job
metadata:
  name: toolbridge-migrate
  namespace: toolbridge
spec:
  # Keep completed jobs for debugging
  ttlSecondsAfterFinished: 86400  # 24 hours
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: toolbridge-migrate
    spec:
      restartPolicy: OnFailure
      initContainers:
      # Wait for postgres to be ready
      - name: wait-for-postgres
        image: postgres:16-alpine
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: toolbridge-secret
              key: postgres-password
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_PORT
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_USER
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_NAME
        command:
          - sh
          - -c
          - |
            until PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c 'SELECT 1' > /dev/null 2>&1; do
              echo "Waiting for postgres..."
              sleep 2
            done
            echo "Postgres is ready!"
      containers:
      - name: migrate
        image: toolbridge-api:latest  # Replace with your actual image
        command: ["/bin/sh", "/app/scripts/migrate.sh"]
        env:
        # Build DATABASE_URL from parts
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: toolbridge-secret
              key: postgres-password
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_PORT
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_NAME
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_USER
        - name: DB_SSLMODE
          valueFrom:
            configMapKeyRef:
              name: toolbridge-config
              key: DB_SSLMODE
        - name: DATABASE_URL
          value: "postgres://$(DB_USER):$(POSTGRES_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=$(DB_SSLMODE)"
