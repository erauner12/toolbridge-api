{{- if .Values.postgresql.enabled }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ include "toolbridge-api.fullname" . }}-postgres
  labels:
    {{- include "toolbridge-api.labels" . | nindent 4 }}
spec:
  instances: {{ .Values.postgresql.instances }}
  imageName: {{ .Values.postgresql.imageName }}

  # Bootstrap with initdb
  bootstrap:
    initdb:
      database: {{ .Values.config.dbName }}
      owner: {{ .Values.config.dbUser }}
      secret:
        name: {{ include "toolbridge-api.secretName" . }}

  # Storage configuration
  storage:
    size: {{ .Values.postgresql.size }}
    storageClass: {{ .Values.postgresql.storageClass }}

  # PostgreSQL configuration
  postgresql:
    parameters:
      {{- toYaml .Values.postgresql.parameters | nindent 6 }}

  # Monitoring
  monitoring:
    enablePodMonitor: {{ .Values.postgresql.monitoring.enablePodMonitor }}

  # High availability
  primaryUpdateStrategy: {{ .Values.postgresql.primaryUpdateStrategy }}

  {{- if .Values.postgresql.backup.enabled }}
  # Backup configuration
  backup:
    barmanObjectStore:
      destinationPath: {{ .Values.postgresql.backup.destinationPath | quote }}
      endpointURL: {{ .Values.postgresql.backup.endpointURL | quote }}
      s3Credentials:
        accessKeyId:
          name: {{ .Values.postgresql.backup.s3Credentials.accessKeyId.name }}
          key: {{ .Values.postgresql.backup.s3Credentials.accessKeyId.key }}
        secretAccessKey:
          name: {{ .Values.postgresql.backup.s3Credentials.secretAccessKey.name }}
          key: {{ .Values.postgresql.backup.s3Credentials.secretAccessKey.key }}
    retentionPolicy: {{ .Values.postgresql.backup.retentionPolicy | quote }}
  {{- end }}
{{- end }}
