{{- include "toolbridge-api.validateOAuthClients" . -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "toolbridge-api.fullname" . }}-config
  labels:
    {{- include "toolbridge-api.labels" . | nindent 4 }}
  {{- if or .Values.oauthClients.userClient.clientId .Values.oauthClients.mcpClient.clientId }}
  annotations:
    # OAuth client registry for reference (not used by the application)
    {{- if .Values.oauthClients.userClient.clientId }}
    toolbridge.dev/oauth-user-client: {{ .Values.oauthClients.userClient.clientId | quote }}
    toolbridge.dev/oauth-user-client-name: {{ .Values.oauthClients.userClient.name | quote }}
    {{- end }}
    {{- if and .Values.oauthClients.mcpClient.enabled .Values.oauthClients.mcpClient.clientId }}
    toolbridge.dev/oauth-mcp-client: {{ .Values.oauthClients.mcpClient.clientId | quote }}
    toolbridge.dev/oauth-mcp-client-name: {{ .Values.oauthClients.mcpClient.name | quote }}
    {{- end }}
  {{- end }}
data:
  ENV: {{ .Values.api.env | quote }}
  HTTP_ADDR: {{ .Values.api.httpAddr | quote }}
  {{- if .Values.grpc.enabled }}
  GRPC_ADDR: {{ .Values.grpc.addr | quote }}
  {{- end }}
  DB_HOST: {{ .Values.config.dbHost | default (include "toolbridge-api.database.serviceName" .) | quote }}
  DB_PORT: {{ .Values.config.dbPort | quote }}
  DB_NAME: {{ .Values.config.dbName | quote }}
  DB_USER: {{ .Values.config.dbUser | quote }}
  DB_SSLMODE: {{ .Values.config.dbSslMode | quote }}
  {{- if .Values.api.jwt }}
  {{- if .Values.api.jwt.issuer }}
  JWT_ISSUER: {{ .Values.api.jwt.issuer | quote }}
  {{- end }}
  {{- if .Values.api.jwt.jwksUrl }}
  JWT_JWKS_URL: {{ .Values.api.jwt.jwksUrl | quote }}
  {{- end }}
  {{- $jwtAudience := include "toolbridge-api.jwt.audience" . }}
  {{- if $jwtAudience }}
  JWT_AUDIENCE: {{ $jwtAudience | quote }}
  {{- end }}
  {{- if .Values.api.jwt.tenantClaim }}
  TENANT_CLAIM: {{ .Values.api.jwt.tenantClaim | quote }}
  {{- end }}
  {{- end }}
  {{- if .Values.api.mcp.enabled }}
  {{- $mcpAudience := include "toolbridge-api.mcp.audience" . }}
  MCP_OAUTH_AUDIENCE: {{ $mcpAudience | default "" | quote }}
  {{- end }}
  {{- if .Values.api.tenancy }}
  {{- if .Values.api.tenancy.defaultTenantId }}
  DEFAULT_TENANT_ID: {{ .Values.api.tenancy.defaultTenantId | quote }}
  {{- end }}
  {{- end }}
