# Default values for toolbridge-api

# Image configuration
image:
  repository: ghcr.io/erauner12/toolbridge-api
  pullPolicy: IfNotPresent
  tag: "v0.2.0"

# Number of API replicas
# NOTE: Currently limited to 1 due to in-memory session/rate-limit storage
# Sessions and rate limiters are stored in-memory per pod, not shared across replicas.
# With replicaCount > 1, users will experience intermittent 428 errors when their
# session isn't found (requests hit different pods).
# TODO: Increase to 2+ after implementing Redis-backed session storage (see Plans/redis-distributed-state.md)
replicaCount: 1

# Service account
serviceAccount:
  create: true
  name: toolbridge-api

# API deployment configuration
api:
  env: production
  httpAddr: ":8080"

  # MCP (Model Context Protocol) configuration
  # Enable tenant header validation for MCP deployments
  mcp:
    enabled: false  # Set to true to enable tenant header validation

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Health check configuration
  livenessProbe:
    httpGet:
      path: /healthz
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /healthz
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3  # More lenient to avoid marking pods unready on transient failures

# gRPC configuration
grpc:
  # Enable gRPC server (disabled by default for backward compatibility)
  enabled: false

  # gRPC server address
  addr: ":8082"

  # gRPC service port configuration
  port: 8082

# Database configuration
postgresql:
  enabled: true
  instances: 2
  size: 10Gi
  storageClass: longhorn
  imageName: ghcr.io/cloudnative-pg/postgresql:16

  # PostgreSQL parameters
  parameters:
    max_connections: "100"
    shared_buffers: "256MB"
    effective_cache_size: "1GB"
    maintenance_work_mem: "64MB"
    checkpoint_completion_target: "0.9"
    wal_buffers: "16MB"
    default_statistics_target: "100"
    random_page_cost: "1.1"
    effective_io_concurrency: "200"
    work_mem: "2621kB"
    min_wal_size: "1GB"
    max_wal_size: "4GB"

  # Monitoring
  monitoring:
    enablePodMonitor: true

  # High availability
  primaryUpdateStrategy: unsupervised

# Migration job configuration
migration:
  enabled: true
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400  # 24 hours

  # Init container to wait for postgres
  waitForPostgres:
    image: postgres:16-alpine

# Service configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8080

# HTTPRoute (Gateway API ingress)
ingress:
  enabled: true
  gateway:
    name: envoy-public
    namespace: network
  hostname: ""  # Set via override, e.g., toolbridge-api.example.com
  annotations: {}  # Optional annotations for HTTPRoute (e.g., external-dns)

  # Retry configuration for BackendTrafficPolicy
  retry:
    numRetries: 3  # Retry up to 3 times on connection failures
    perRetryTimeout: 2s  # Timeout for each retry attempt

  # Timeout configuration
  timeout:
    request: 30s  # Overall request timeout

  # Load balancer configuration
  loadBalancer:
    type: RoundRobin  # RoundRobin, LeastRequest, or Random

# Certificate configuration
certificate:
  enabled: true
  issuerRef:
    name: letsencrypt-cloudflare-prod
    kind: ClusterIssuer
  dnsNames: []  # Set via override

# Secrets configuration
secrets:
  # External secrets management
  # Set these via sealed secrets, external secrets operator, or SOPS
  jwtSecret: ""          # JWT signing secret (base64)
  dbUsername: ""         # Database username
  dbPassword: ""         # Database password (base64)
  databaseUrl: ""        # Complete DATABASE_URL (base64)
  tenantHeaderSecret: "" # Tenant header HMAC secret (required when api.mcp.enabled=true)

  # Use existing secret instead of creating one
  existingSecret: ""

# ConfigMap configuration
config:
  dbHost: ""  # Auto-computed as {{ releaseName }}-postgres-rw (e.g., toolbridge-api-postgres-rw). Override if needed.
  dbPort: "5432"
  dbName: toolbridge
  dbUser: toolbridge
  dbSslMode: require

# RBAC configuration
rbac:
  create: true
  rules:
    - apiGroups: ["batch"]
      resources: ["jobs"]
      verbs: ["get", "list", "watch"]

# Pod Security Context
podSecurityContext: {}

# Security Context
securityContext: {}

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}
