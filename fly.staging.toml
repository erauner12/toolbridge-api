# Fly.io configuration for ToolBridge MCP staging deployment (WorkOS AuthKit)
# This deploys the Python MCP server with per-user OAuth authentication
# The Go API and PostgreSQL run in K8s (https://toolbridgeapi.erauner.dev)
#
# WorkOS AuthKit OAuth 2.1 Flow:
#   - Users authenticate via claude.ai web UI (browser-based OAuth)
#   - FastMCP AuthKitProvider validates user tokens
#   - MCP server exchanges user tokens for backend JWTs
#   - Backend JWT used for Go API calls with per-user sessions
#
# Setup:
#   1. Create app: fly apps create toolbridge-mcp-staging
#   2. Configure WorkOS AuthKit domain (via WorkOS Dashboard)
#   3. Set secrets: fly secrets set ... (see below)
#   4. Deploy: fly deploy --config fly.staging.toml
#   5. Add connector in claude.ai → Settings → Connectors

app = "toolbridge-mcp-staging"
primary_region = "ord"  # Chicago - adjust based on K8s cluster location
kill_signal = "SIGINT"
kill_timeout = "5s"

[build]
  dockerfile = "Dockerfile.mcp-only"

[env]
  # Application environment
  ENV = "staging"

  # Python MCP configuration
  # Note: TOOLBRIDGE_GO_API_BASE_URL must point to your K8s ingress
  TOOLBRIDGE_HOST = "0.0.0.0"
  TOOLBRIDGE_PORT = "8001"
  TOOLBRIDGE_LOG_LEVEL = "INFO"

# Secrets to set via `fly secrets set`:
#
# WorkOS AuthKit Configuration (REQUIRED)
# - TOOLBRIDGE_AUTHKIT_DOMAIN            WorkOS AuthKit domain (e.g., toolbridge.authkit.app)
# - TOOLBRIDGE_PUBLIC_BASE_URL           Public MCP URL (e.g., https://toolbridge-mcp-staging.fly.dev)
# - TOOLBRIDGE_BACKEND_API_AUDIENCE      Backend API audience (e.g., https://toolbridgeapi.erauner.dev)
#
# Backend API Configuration (REQUIRED)
# - TOOLBRIDGE_GO_API_BASE_URL           External Go API URL (K8s ingress)
# - TOOLBRIDGE_TENANT_ID                 Unique tenant identifier
# - TOOLBRIDGE_TENANT_HEADER_SECRET      HMAC signing secret (must match K8s)
#
# Optional: JWT Signing (for token exchange without backend endpoint)
# - TOOLBRIDGE_JWT_SIGNING_KEY           RS256 private key for issuing backend JWTs

# HTTP service (Python MCP)
[[services]]
  protocol = "tcp"
  internal_port = 8001
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0
  processes = ["app"]

  [[services.ports]]
    port = 80
    handlers = ["http"]
    force_https = true

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  [services.concurrency]
    type = "connections"
    hard_limit = 50
    soft_limit = 40

  [[services.tcp_checks]]
    interval = "15s"
    timeout = "2s"
    grace_period = "10s"

  # Health checks disabled - FastMCP HTTP endpoint requires authentication
  # TODO: Add dedicated public health endpoint in future PR
  # [[services.http_checks]]
  #   interval = "30s"
  #   timeout = "5s"
  #   grace_period = "15s"
  #   method = "GET"
  #   path = "/mcp"
  #   protocol = "http"
  #   tls_skip_verify = false

[http_service]
  internal_port = 8001
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0
  processes = ["app"]

  [http_service.concurrency]
    type = "connections"
    hard_limit = 50
    soft_limit = 40

# VM configuration (small instance for MCP proxy)
[vm]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512

# ============================================================================
# Secrets Configuration Reference (WorkOS AuthKit)
# ============================================================================
# Set these via `fly secrets set -a toolbridge-mcp-staging`:
#
# WorkOS AuthKit (REQUIRED):
#   TOOLBRIDGE_AUTHKIT_DOMAIN           - WorkOS AuthKit domain (e.g., toolbridge.authkit.app)
#   TOOLBRIDGE_PUBLIC_BASE_URL          - Public MCP URL
#   TOOLBRIDGE_BACKEND_API_AUDIENCE     - Backend API audience
#
# Backend API (REQUIRED):
#   TOOLBRIDGE_GO_API_BASE_URL          - External Go API URL (K8s ingress)
#   TOOLBRIDGE_TENANT_ID                - Unique tenant identifier
#   TOOLBRIDGE_TENANT_HEADER_SECRET     - HMAC signing secret (matches K8s)
#
# Optional:
#   TOOLBRIDGE_LOG_LEVEL                - DEBUG, INFO, WARNING, ERROR (default: INFO)
#   TOOLBRIDGE_JWT_SIGNING_KEY          - RS256 private key for token exchange
#
# Example:
#   fly secrets set -a toolbridge-mcp-staging \
#     TOOLBRIDGE_AUTHKIT_DOMAIN="toolbridge.authkit.app" \
#     TOOLBRIDGE_PUBLIC_BASE_URL="https://toolbridge-mcp-staging.fly.dev" \
#     TOOLBRIDGE_BACKEND_API_AUDIENCE="https://toolbridgeapi.erauner.dev" \
#     TOOLBRIDGE_GO_API_BASE_URL="https://toolbridgeapi.erauner.dev" \
#     TOOLBRIDGE_TENANT_ID="staging-tenant-001" \
#     TOOLBRIDGE_TENANT_HEADER_SECRET="$(openssl rand -base64 32)"
# ============================================================================

# ============================================================================
# Deployment Commands (WorkOS AuthKit)
# ============================================================================
# Initial setup:
#   1. Create Fly.io app:
#      fly apps create toolbridge-mcp-staging
#
#   2. Configure WorkOS AuthKit (via WorkOS Dashboard):
#      - Create or configure your AuthKit environment
#      - Note your AuthKit domain (e.g., toolbridge.authkit.app)
#      - Configure allowed redirect URIs for MCP integration
#
#   3. Set Fly.io secrets (see example above):
#      fly secrets set -a toolbridge-mcp-staging ...
#
#   4. Deploy:
#      fly deploy --config fly.staging.toml -a toolbridge-mcp-staging
#
#   5. Verify OAuth metadata:
#      curl https://toolbridge-mcp-staging.fly.dev/.well-known/oauth-protected-resource/mcp
#
#   6. Add connector in Claude Desktop:
#      - Open https://claude.ai
#      - Settings → Connectors → Add Connector
#      - URL: https://toolbridge-mcp-staging.fly.dev/mcp
#      - Authenticate via browser (WorkOS AuthKit OAuth flow)
#
# Update deployment:
#   fly deploy --config fly.staging.toml -a toolbridge-mcp-staging
#
# View logs:
#   fly logs -a toolbridge-mcp-staging --tail
#
# Check status:
#   fly status -a toolbridge-mcp-staging
#
# Test token exchange:
#   # Get your OAuth token from claude.ai (inspect network tab)
#   curl -X POST https://toolbridgeapi.erauner.dev/auth/token-exchange \
#     -H "Authorization: Bearer YOUR_MCP_OAUTH_TOKEN" \
#     -H "Content-Type: application/json" \
#     -d '{"grant_type":"urn:ietf:params:oauth:grant-type:token-exchange","audience":"https://toolbridgeapi.erauner.dev"}'
#
# Scale (if needed):
#   fly scale count 2 -a toolbridge-mcp-staging
#   fly scale vm shared-cpu-2x --memory 1024 -a toolbridge-mcp-staging
# ============================================================================
